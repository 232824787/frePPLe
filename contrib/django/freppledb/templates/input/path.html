{% extends "admin/base_site_grid.html" %}
{% load i18n %}

{% block contextmenus %}
{% include "operationcontext.html" %}
{% include "itemcontext.html" %}
{% include "buffercontext.html" %}
{% include "demandcontext.html" %}
{% include "resourcecontext.html" %}
{% include "locationcontext.html" %}
{% endblock %}

{% block extrahead %}{{block.super}}
<style type="text/css">
#graph {
  overflow:auto;
  border: 1px black solid;
  margin: 10px;
  padding: 10px;
}
</style>
<script src="{{STATIC_URL}}js/d3.min.js"></script>
<script type="text/javascript">

function reslistfmt(cellvalue, options, row)
{
  if (cellvalue === undefined || cellvalue ==='') return '';
  result = '';
  console.log(cellvalue);
  for (var i in cellvalue)
    result += "<span>" + cellvalue[i][0] + "<span class='context ui-icon ui-icon-triangle-1-e' role='resource'></span></span><br/>";
  return result;
}

function clickedShaped(event) {

  var tgt = event.currentTarget.firstChild.textContent;

  // Find which contextmenu to use
  if (/^B/.test(tgt)) contextMenu = $('#buffercontext');
  if (/^R/.test(tgt)) contextMenu = $('#resourcecontext');
  if (/^O/.test(tgt) || /^cluster_O/.test(tgt)) contextMenu = $('#operationcontext');

  // Find the id of the menu to display
  if (/^cluster_O/.test(tgt))
    name_escaped = encodeURIComponent(tgt.substring(9).replace(/&amp;/g,'&').replace(/&lt;/g,'<')
      .replace(/&gt;/g,'>').replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/\//g,"_2F"));
  else
    name_escaped = encodeURIComponent(tgt.substring(1).replace(/&amp;/g,'&').replace(/&lt;/g,'<')
      .replace(/&gt;/g,'>').replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/\//g,"_2F"));

  // Build the URLs for the menu
  var params = {value: name_escaped};
  contextMenu.find('a').each( function() {
    $(this).attr('href', $(this).attr('id').replace(/{\w+}/g, function(match, number) {
    var key = match.substring(1,match.length-1);
    return key in params ? params[key] : match;
    }
    ))
  });

  // Display the menu at the right location
  $(contextMenu).css({
    left: event.pageX,
    top: event.pageY,
    display: 'block'
    });
  event.preventDefault();
  event.stopImmediatePropagation();
}

$(function(){
  if ($("#graph").height() > $(window).height() - 350)
    $("#graph").height($(window).height() - 350);
  $("#graph").resizable({handles: "s,se"});
  $("g.node").click(clickedShaped);
  $("g.cluster").click(clickedShaped);
  $("svg").click(function() {
    $(".ContextMenu").css('display', 'none');
    });
});

</script>
{% endblock %}
{% block extra_grid %}treeGrid: true,
treeGridModel: 'adjacency',
ExpandColumn: 'depth',
treeIcons: {
  plus:'ui-icon-circle-triangle-e',
  minus:'ui-icon-circle-triangle-s',
  leaf:'ui-icon-radio-off'
  },
tree_root_level: 0,
treeReader: {
  level_field: 'depth',
  parent_id_field: 'parent',
  leaf_field: 'leaf',
  expanded_field: 'expanded'
  },
ExpandColClick: true,
{% endblock %}


{% block tools %}
{% tabs model %}
{% endblock %}
